<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ULTRA Production Leaderboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 15px;
}

h1 {
    text-align: center;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card {
    background: #fff;
    border-radius: 12px;
    padding: 15px;
    margin: 12px 0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.rank {
    background: #ddd;
    border-radius: 6px;
    display: inline-block;
    padding: 4px 8px;
    font-weight: bold;
}

.blue { background: #2979ff; color: #fff; }
.greenbg { background: #43a047; color: #fff; }
.redbg { background: #FDDA0D; color: #fff; }

progress {
    width: 100%;
    height: 18px;
}

input {
    width: 80px;
    padding: 6px;
}

button {
    padding: 7px 12px;
    border-radius: 6px;
}

.input-row {
    display: flex;
    gap: 10px;
    align-items: center;
}

.green { color: #00cc5a; font-weight: bold; }
.red { color: #ff4a4a; font-weight: bold; }

.timestamp {
    font-size: 11px;
    color: #777;
    position: absolute;
    right: 10px;
    top: 8px;
}
</style>
</head>

<body>

<div class="header">
    <h1>ULTRA Production Leaderboard</h1>
    <button onclick="toggleDark()">ðŸŒ™ Dark Mode</button>
</div>

<div id="board"></div>

<div class="footer" style="text-align:center;color:#777;">
Target: <b>4,000 parts/hr</b> â€¢ Daily target: <b>36,000 parts</b>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ===== DOM References =====
const board = document.getElementById("board");

// ===== Dark Mode Toggle =====
function toggleDark(){
    document.body.classList.toggle("dark");
}

// ===== Firebase Initialization =====
let db = null;
try {
    firebase.initializeApp({
        apiKey: "AIzaSyBjEcJRy9C_WXJYhqLaBEZJ54ZwpEgH8qE",
        authDomain: "ultra-production-board.firebaseapp.com",
        projectId: "ultra-production-board",
        storageBucket: "ultra-production-board.firebasestorage.app",
        messagingSenderId: "1058393515822",
        appId: "1:1058393515822:web:a706cdbc8c02cc0c0e3cbf"
    });
    db = firebase.database();
} catch(e) {
    console.warn("Firebase failed to load:", e);
}

// ===== Constants =====
const DAILY_TARGET = 36000;
const teams = ["ULTRA1","ULTRA2","ULTRA3"];
const START_HOUR = 9;
const TARGET_PER_HOUR = 4000;
const TARGET_PER_MIN = TARGET_PER_HOUR / 60;

// ===== Functions =====
function save(name){
    if (!db) return;
    db.ref("production/"+name).set({
        total: +document.getElementById(name).value,
        lastUpdated: new Date().toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" })
    });
}

function renderBoard(data){
    const now = new Date();
    const shiftStart = new Date();
    shiftStart.setHours(START_HOUR,0,0,0);
    let minsElapsed = Math.max(0,(now - shiftStart)/60000);
    const expectedSoFar = minsElapsed * TARGET_PER_MIN;

    const totals = teams.map(t=>({
        name: t,
        total: data?.[t]?.total || 0,
        lastUpdated: data?.[t]?.lastUpdated || "--"
    })).sort((a,b)=> b.total - a.total);

    board.innerHTML = "";

    totals.forEach((team,i)=>{
        const pct = Math.min(team.total / DAILY_TARGET * 100, 100);
        const diff = team.total - expectedSoFar;
        const diffClass = diff >= 0 ? "green" : "red";

        const absMins = Math.abs(diff) / TARGET_PER_MIN;
        const h = Math.floor(absMins / 60);
        const m = Math.round(absMins % 60);

        const timeText = h > 0
            ? `â‰ˆ ${h}h ${m}m ${diff >= 0 ? "ahead" : "behind"}`
            : `â‰ˆ ${m} min ${diff >= 0 ? "ahead" : "behind"}`;

        const diffText = diff >= 0
            ? `Ahead by ${Math.round(diff)} parts`
            : `Behind by ${Math.round(Math.abs(diff))} parts`;

        board.innerHTML += `
<div class="card" style="position:relative">
    <span class="rank">#${i+1}</span>

    <span class="${
            team.name=="ULTRA1" ? "blue" :
            team.name=="ULTRA2" ? "greenbg" :
            "redbg"
        }">${team.name}</span>

    <div class="input-row">
        <input id="${team.name}" type="number" value="${team.total}">
        <button onclick="save('${team.name}')">Update</button>
    </div>

    <div class="diff ${diffClass}">
        ${diffText}<br>(${timeText})
    </div>

    <progress value="${pct}" max="100"></progress>
    
    <p>${team.total} parts</p>

    <p class="timestamp">
        Last update: ${team.lastUpdated}
    </p>
</div>`;
    });
}

// ===== Load Data =====
function loadBoard(){
    if (!db) return;
    db.ref("production").on("value", s => {
        renderBoard(s.val() || {});
    });
}

// ===== Auto Reset Board at 7AM =====
function autoResetCheck() {
    if (!db) return;
    const now = new Date();
    const hour = now.getHours();
    const min = now.getMinutes();
    const today = now.toDateString();
    const alreadyReset = localStorage.getItem("lastReset");

    if(hour === 7 && min === 0 && alreadyReset !== today){
        teams.forEach(team => {
            db.ref("production/" + team).set({
                total: 0,
                lastUpdated: new Date().toLocaleTimeString()
            });
        });
        localStorage.setItem("lastReset", today);
        console.log("âœ… Daily reset complete");
    }
}

// ===== Initialize =====
loadBoard();
autoResetCheck();
setInterval(autoResetCheck, 60000);

</script>

</body>
</html>
