<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ULTRA Production Leaderboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
    font-family: Arial, sans-serif;
    background:#f4f6f8;
    margin:0;
    padding:15px;
}

h1{text-align:center;}

.header{
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.card{
    background:#fff;
    border-radius:12px;
    padding:15px;
    margin:12px 0;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

/* ===== BOARD ===== */

.rank{
    background:#ddd;
    border-radius:6px;
    display:inline-block;
    padding:4px 8px;
    font-weight:bold;
}

.blue{background:#2979ff;color:#fff;}
.greenbg{background:#43a047;color:#fff;}
.redbg{background:#FDDA0D;color:#fff;}

progress{
    width:100%;
    height:18px;
}

/* ===== DARK MODE ===== */

body.dark{
    background:#121212;
    color:#eee;
}
.dark .card{background:#1e1e1e;}
.dark input,.dark button{
    background:#333;
    color:#fff;
    border-color:#555;
}

/* ===== INPUTS ===== */

input{
    width:80px;
    padding:6px;
}
button{
    padding:7px 12px;
    border-radius:6px;
}

.lock{text-align:center;margin-bottom:20px;}
.input-row{display:flex;gap:10px;align-items:center;}

.green{color:#00cc5a;font-weight:bold;}
.red{color:#ff4a4a;font-weight:bold;}

.timestamp{
    font-size:11px;
    color:#777;
    position:absolute;
    right:10px;
    top:8px;
}

/* ===== BAUBLES ===== */

.swing-wrapper{
    position:absolute;
    top:0;
    transform-origin: top center;
    animation:swing ease-in-out infinite alternate;
}

@keyframes swing{
    from{transform:rotate(-6deg);}
    to{transform:rotate(6deg);}
}

.string{
    width:2px;
    background:#FFC000;
    margin:0 auto;
    box-shadow: 0 0 6px rgba(255,192,0,0.85);
}

.bauble{
    border-radius:50%;
    margin:0 auto;
    background:
      radial-gradient(circle at 35% 30%, #fff 5%, var(--c1) 35%, var(--c2) 80%);
    box-shadow:
        inset -2px -4px 8px rgba(0,0,0,.35),
        0 0 7px rgba(255,255,255,.35);
}

/* ===== SNOW ===== */

#snow{
    position:fixed;
    inset:0;
    pointer-events:none;
    z-index:999;
}

.snowflake{
    position:absolute;
    top:-10px;
    background:white;
    border-radius:50%;
    filter: blur(.4px);
    opacity:.9;
    animation:fall linear infinite, drift ease-in-out infinite;
}

@keyframes fall{
    to{transform:translateY(110vh);}
}

@keyframes drift{
    0%,100%{margin-left:0;}
    50%{margin-left:25px;}
}
    /* SPEEDOMETER */

.gauge {
    width: 140px;
    height: 70px;
    border: 5px solid #ccc;
    border-bottom: none;
    border-radius: 140px 140px 0 0;
    margin: 10px auto 0;
    position: relative;
    overflow: hidden;
}

.needle {
    width: 3px;
    height: 65px;
    background: red;
    position: absolute;
    bottom: 0;
    left: 50%;
    transform-origin: bottom center;
    transform: rotate(-90deg);
    transition: 0.6s ease;
}

.speed-text {
    text-align: center;
    font-weight: bold;
    margin: 4px 0;
}
    /* ===== PROGRESS BAR ROW ===== */
.progress-row{
    display:flex;
    align-items:center;
    gap:18px;
}

/* Shorter thicker bar */
progress{
    width:60%;
    height:16px;
}

/* ===== SPEED GAUGE ===== */
.gauge{
    width:70px;
    height:35px;
    border:2px solid #aaa;
    border-top-left-radius:70px;
    border-top-right-radius:70px;
    border-bottom:none;
    position:relative;
    overflow:hidden;
}

.needle{
    width:2px;
    height:38px;
    background:red;
    position:absolute;
    bottom:0;
    left:50%;
    transform-origin:bottom center;
    transform:rotate(-90deg);
    transition:0.6s ease-out;
}

/* text below gauge */
.speed-text{
    font-size:0.8em;
    margin:2px 0 0 0;
    text-align:center;
}
</style>
</head>

<body>

<div id="snow"></div>

<div class="header">
    <h1>ULTRA Production Leaderboard</h1>
    <button onclick="toggleDark()">ðŸŒ™ Dark Mode</button>
</div>

<div class="lock">
<h3>Enter PIN to unlock editing</h3>
<input type="password" id="pinInput" maxlength="4">
<button onclick="unlock()">Unlock</button>
</div>

<div id="board"></div>

<div class="footer" style="text-align:center;color:#777;">
Target: <b>4,000 parts/hr</b> â€¢ Daily target: <b>36,000 parts</b>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
 apiKey: "AIzaSyBjEcJRy9C_WXJYhqLaBEZJ54ZwpEgH8qE",
 authDomain: "ultra-production-board.firebaseapp.com",
 projectId: "ultra-production-board",
 storageBucket: "ultra-production-board.firebasestorage.app",
 messagingSenderId: "1058393515822",
 appId: "1:1058393515822:web:a706cdbc8c02cc0c0e3cbf"
});

const db=firebase.database();

const PIN="0711";
const DAILY_TARGET=36000;
let unlocked=false;

const teams=["ULTRA1","ULTRA2","ULTRA3"];

function toggleDark(){
    document.body.classList.toggle("dark");
}

function unlock(){
    if(pinInput.value===PIN){
        unlocked=true;
        document.querySelector(".lock").style.display="none";
        loadBoard();
    } else alert("Wrong PIN");
}

function loadBoard(){
    db.ref("production").on("value",s=>{
        renderBoard(s.val()||{});
    });
}
function updateGauge(team, total) {

    const hoursWorked = getWorkHours(); // you already calculate this

    // Parts per hour current speed
    const speed = hoursWorked > 0 ? Math.round(total / hoursWorked) : 0;

    const maxSpeed = 5000;   // needle max
    const limited = Math.min(speed, maxSpeed);

    // Convert to needle angle (-90 to +90 degrees)
    const angle = ((limited / maxSpeed) * 180) - 90;

    // Apply needle
    const needle = document.getElementById("needle-" + team);
    if(needle) needle.style.transform = `rotate(${angle}deg)`;

    // Colour logic
    if(speed >= 4000){
        needle.style.background = "lime";
    } else if (speed >= 3500){
        needle.style.background = "gold";
    } else {
        needle.style.background = "red";
    }

    // Display text
    document.getElementById("speed-" + team).innerText = `${speed} pph`;
}
function save(name){
    db.ref("production/"+name).set({
        total:+document.getElementById(name).value,
        lastUpdated:new Date().toLocaleTimeString([],{
            hour:"2-digit",
            minute:"2-digit"
        })
    });
}
function renderBoard(data){

    const now = new Date();

    // ===== SHIFT TIMING =====
    const START_HOUR = 9;               
    const TARGET_PER_HOUR = 4000;
    const TARGET_PER_MIN = TARGET_PER_HOUR / 60;

    const shiftStart = new Date();
    shiftStart.setHours(START_HOUR,0,0,0);

    let minsElapsed = Math.max(0,(now - shiftStart) / 60000);

    const expectedSoFar = minsElapsed * TARGET_PER_MIN;

    // ===== TOTALS =====
    const totals = teams.map(t=>({
        name: t,
        total: data[t]?.total || 0,
        lastUpdated: data[t]?.lastUpdated || "--"
    }))
    .sort((a,b)=> b.total - a.total);

    board.innerHTML = "";

    // ========= BUILD HTML FIRST =========
    totals.forEach((team,i)=>{

        const pct = Math.min(team.total / DAILY_TARGET * 100, 100);

        // ===== AHEAD / BEHIND CALC =====
        const diff = team.total - expectedSoFar;
        const diffClass = diff >= 0 ? "green" : "red";

        const absMins = Math.abs(diff) / TARGET_PER_MIN;
        const h = Math.floor(absMins / 60);
        const m = Math.round(absMins % 60);

        const timeText = h > 0
            ? `â‰ˆ ${h}h ${m}m ${diff >= 0 ? "ahead" : "behind"}`
            : `â‰ˆ ${m} min ${diff >= 0 ? "ahead" : "behind"}`;

        const diffText = diff >= 0
            ? `Ahead by ${Math.round(diff)} parts`
            : `Behind by ${Math.round(Math.abs(diff))} parts`;

        board.innerHTML += `
<div class="card" style="position:relative">
    <span class="rank">#${i+1}</span>

    <span class="${
            team.name=="ULTRA1" ? "blue" :
            team.name=="ULTRA2" ? "greenbg" :
            "redbg"
        }">${team.name}</span>

    <div class="input-row">
        <input id="${team.name}"
               type="number"
               value="${team.total}"
               ${unlocked?"":"disabled"}>

        <button onclick="save('${team.name}')"
                ${unlocked?"":"disabled"}>
            Update
        </button>
    </div>

    <div class="diff ${diffClass}">
        ${diffText}<br>
        (${timeText})
    </div>

<div class="progress-row">

    <progress value="${pct}" max="100"></progress>

    <div>
        <div class="gauge">
            <div class="needle" id="needle-${team.name}"></div>
        </div>
        <p class="speed-text" id="speed-${team.name}">-- pph</p>
    </div>

</div>
    <p>${team.total} parts</p>

    <p class="timestamp">
        Last update: ${team.lastUpdated}
    </p>
</div>`;
    });

    // ========= UPDATE SPEEDOMETERS AFTER DOM EXISTS =========
    totals.forEach(team=>{
        updateGauge(team.name, team.total);
    });

}
function updateGauge(team,total){

    const needle=document.getElementById("needle-"+team);
    const speedText=document.getElementById("speed-"+team);

    if(!needle) return;

    const now=new Date();

    const shiftStart=new Date();
    shiftStart.setHours(START_HOUR,0,0,0);

    const minsElapsed=Math.max(1,(now-shiftStart)/60000);
    const hours=minsElapsed/60;

    // Parts per hour
    const pph=Math.round(total / hours);

    speedText.textContent = `${pph} pph`;

    // Needle rotation
    // Map 0â€“6000 pph across -90Â° to +90Â°
    let angle=(pph/6000)*180 - 90;

    angle=Math.max(-90,Math.min(90,angle));

    needle.style.transform=`rotate(${angle}deg)`;
}
/* ===== BAUBLES ===== */

const colors=[["#ff3366","#a1002b"],["#ffd24a","#a77300"],
              ["#44ffaa","#007c43"],["#7b6bff","#281d88"]];

for(let i=0;i<9;i++){
    const wrap=document.createElement("div");
    wrap.className="swing-wrapper";

    wrap.style.left=(5+i*(90/9))+"%";
    wrap.style.animationDuration=(3+Math.random()*2)+"s";

    const d=40+Math.random()*60;

    const s=document.createElement("div");
    s.className="string";
    s.style.height=d+"px";

    const b=document.createElement("div");
    b.className="bauble";

    const size=20+Math.random()*15;
    b.style.width=b.style.height=size+"px";

    const c=colors[Math.floor(Math.random()*colors.length)];
    b.style.setProperty("--c1",c[0]);
    b.style.setProperty("--c2",c[1]);

    wrap.appendChild(s);
    wrap.appendChild(b);
    document.body.appendChild(wrap);
}

/* ===== SNOW ===== */

const snow=document.getElementById("snow");

setInterval(()=>{
    const flake=document.createElement("div");
    flake.className="snowflake";

    const size=Math.random()*5+2;
    flake.style.width=flake.style.height=size+"px";
    flake.style.left=Math.random()*100+"vw";

    const speed=Math.random()*6+5;
    flake.style.animationDuration=speed+"s,3s";

    snow.appendChild(flake);

    setTimeout(()=>flake.remove(),(speed+1)*1000);
},90);

// ===============================
// AUTO RESET BOARD AT 7AM DAILY
// ===============================

function autoResetCheck() {

    const now = new Date();

    const hour = now.getHours();
    const min = now.getMinutes();

    // Get today's date string
    const today = now.toDateString();

    // Prevent multiple resets in same day
    const alreadyReset = localStorage.getItem("lastReset");

    // Reset at exactly 7:00 AM
    if(hour === 7 && min === 0 && alreadyReset !== today) {

        teams.forEach(team => {
            db.ref("production/" + team).set({
                total: 0,
                lastUpdated: new Date().toLocaleTimeString()
            });
        });

        localStorage.setItem("lastReset", today);

        console.log("âœ… Daily reset complete");
    }
}

// Check every minute
setInterval(autoResetCheck, 60000);

// Run once on page load
autoResetCheck();

</script>

</body>
</html>
