<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ULTRA Production Leaderboard</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<style>
:root{
  --bg:#fbfcfd;
  --card:#ffffff;
  --muted:#6f777b;
  --accent:#d1d6d9;
  --green:#2e9b55;
  --red:#c0392b;
  --yellow:#e8a23b;
  --gold:#f4d35e;
  --silver:#cfcfcf;
  --bronze:#d19a66;
  --max-width:1100px;
  font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
  font-size:15px;
}
*{box-sizing:border-box}
body{background:var(--bg); color:#0f1720; margin:0; padding:22px; display:flex; justify-content:center;}
.container{width:100%; max-width:var(--max-width);}
header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px;}
h1{ margin:0; font-size:22px;}
.controls{display:flex; gap:8px; align-items:center;}
.btn{background:var(--card); border:1px solid var(--accent); padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600;}
.btn.secondary{background:transparent;}
.top-right{font-size:13px; color:var(--muted); margin-left:12px;}
.board{display:grid; grid-template-columns:1fr; gap:14px;}
.team-card{background:var(--card); border:1px solid var(--accent); padding:14px; border-radius:12px; display:flex; gap:12px; align-items:flex-start; box-shadow:0 1px 0 rgba(15,23,32,0.03);}
.team-card.lead-1{outline:3px solid rgba(244,211,94,0.12);}
.team-card.lead-2{outline:3px solid rgba(207,207,207,0.08);}
.team-card.lead-3{outline:3px solid rgba(209,154,102,0.06);}
.left{flex:0 0 58%;}
.right{flex:1; min-width:220px;}
.team-name{font-weight:800; font-size:16px; display:flex; align-items:center; gap:10px; margin-bottom:8px;}
.rank-badge{background:var(--accent); padding:6px 8px; border-radius:8px; font-weight:800;}
.input-row{display:flex; gap:8px; align-items:center; margin-bottom:10px;}
input[type="number"]{padding:10px 12px; border:1px solid var(--accent); border-radius:8px; width:160px; font-size:15px;}
.update-btn{padding:10px 12px; border-radius:8px; background:#fff; border:1px solid var(--accent); cursor:pointer; font-weight:700;}
.meta{font-size:13px; color:var(--muted); display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
.progress-wrap{width:100%; margin-top:6px;}
.progress{height:14px; background:#eef1f3; border-radius:10px; overflow:hidden; border:1px solid var(--accent);}
.progress>i{display:block; height:100%; width:0%; transition:width 500ms ease; border-radius:10px;}
.stats-line{display:flex; justify-content:space-between; align-items:center; margin-top:8px;}
.status{font-weight:700; padding:6px 8px; border-radius:6px; display:inline-block;}
.small{font-size:12px; color:var(--muted);}
.log{margin-top:10px; border-top:1px dashed var(--accent); padding-top:8px;}
.log-item{display:flex; justify-content:space-between; align-items:center; padding:6px; border-radius:6px; margin-top:6px;}
.log-item .left{font-size:13px;}
.log-item .right{font-size:13px; color:var(--muted);}
.log-item.green{background:rgba(46,155,85,0.06); border:1px solid rgba(46,155,85,0.12);}
.log-item.yellow{background:rgba(232,162,59,0.04); border:1px solid rgba(232,162,59,0.08);}
.log-item.red{background:rgba(192,57,43,0.04); border:1px solid rgba(192,57,43,0.08);}
.full-log{margin-top:8px; max-height:220px; overflow:auto; padding:6px; border-radius:8px; background:#fbfdff; border:1px solid rgba(0,0,0,0.03); display:none;}
.controls-row{display:flex; gap:8px; align-items:center;}
.top-stats{display:flex; gap:12px; align-items:center; color:var(--muted); font-size:13px;}
.canvas-wrap{height:140px; margin-top:8px;}
.footer{margin-top:14px; font-size:13px; color:var(--muted);}
@media (max-width:880px){
  .team-card{flex-direction:column;}
  .left,.right{flex:unset; width:100%}
  input[type="number"]{width:100%;}
  .canvas-wrap{height:120px;}
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>ULTRA Production Leaderboard</h1>
      <div class="top-stats">
        <div id="elapsedDisplay" class="small">Elapsed: --</div>
        <div id="nextRefresh" class="small">Next refresh: --</div>
      </div>
    </div>
    <div class="controls">
      <div class="controls-row">
        <button id="resetAll" class="btn">Reset all data</button>
        <button id="exportBtn" class="btn secondary">Export JSON</button>
      </div>
    </div>
  </header>

  <main class="board" id="board"></main>

  <div class="footer">
    <div>Target: <strong>4,000 parts/hour</strong> â€¢ Daily target: <strong>36,000 parts (9 hours)</strong></div>
    <div style="margin-top:6px">Data saved locally in your browser. Logs kept and today's data will start counting from 09:00 each day. Use Export JSON to save backups.</div>
  </div>
</div>

<!-- Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  // Config
  const TEAMS = ['ULTRA1','ULTRA2','ULTRA3'];
  const TARGET_PER_HOUR = 4000;
  const DAILY_TARGET = 36000;
  const START_HOUR = 9; // 09:00
  const STORAGE_KEY = 'ultra_leaderboard_v4';
  const ARCHIVE_PREFIX = 'ultra_archive_';

  // Helpers
  function todayKey(){ const d=new Date(); return d.getFullYear()+'-'+(d.getMonth()+1).toString().padStart(2,'0')+'-'+d.getDate().toString().padStart(2,'0'); }
  function nowISO(){ return new Date().toISOString(); }
  function nice(ts){ return ts ? new Date(ts).toLocaleString() : 'Never'; }
  function hoursElapsed(){
    const now=new Date();
    const start=new Date();
    start.setHours(START_HOUR,0,0,0);
    const diff=(now-start)/1000/3600;
    return Math.max(0,diff);
  }
  function formatHoursMinutes(totalMinutes){
    const sign = totalMinutes<0?'-':'';
    const mins = Math.abs(Math.round(totalMinutes));
    const h = Math.floor(mins/60);
    const m = mins%60;
    return sign + h + 'h ' + m + 'min';
  }

  // Load & reset logic (archive previous day at 09:00)
  function loadData(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return freshData();
      const parsed = JSON.parse(raw);
      // back-compat: ensure log exists
      TEAMS.forEach(t => { if(!parsed[t]) parsed[t]={name:t,total:0,lastUpdated:null,log:[]}; if(!parsed[t].log) parsed[t].log=[]; });
      // if day changed and we are after start, archive previous day's data and reset counts
      const storedDay = parsed._day || null;
      const today = todayKey();
      const now = new Date();
      const afterStart = (now - (new Date().setHours(START_HOUR,0,0,0))) > 0;
      if(storedDay && storedDay !== today && afterStart){
        // archive
        const archiveKey = ARCHIVE_PREFIX + storedDay;
        localStorage.setItem(archiveKey, JSON.stringify(parsed));
        // reset
        const fresh = freshData();
        fresh._day = today;
        saveDataObj(fresh);
        return fresh;
      } else {
        parsed._day = parsed._day || today;
        return parsed;
      }
    }catch(e){
      return freshData();
    }
  }
  function freshData(){
    const obj = {};
    TEAMS.forEach(t => obj[t] = { name:t, total:0, lastUpdated:null, log:[] });
    obj._day = todayKey();
    return obj;
  }
  function saveDataObj(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
  function saveData(){ saveDataObj(data); }

  let data = loadData();

  // UI references
  const board = document.getElementById('board');
  const elapsedDisplay = document.getElementById('elapsedDisplay');
  const nextRefresh = document.getElementById('nextRefresh');

  // Chart storage per team (Chart.js instances)
  const charts = {};

  // Utilities for logging
  function pushLog(teamName, partsProduced, ratePerHour, status){
    const entry = { ts: nowISO(), partsProduced: Math.round(partsProduced), ratePerHour: Math.round(ratePerHour), status };
    const team = data[teamName];
    team.log = team.log || [];
    team.log.unshift(entry);
    // keep full history in storage but only show 3 by default; we keep up to 200 entries to avoid runaway storage
    if(team.log.length > 200) team.log = team.log.slice(0,200);
  }

  // compute derived values per team
  function computeTeam(t){
    const total = Number(t.total) || 0;
    const elapsed = hoursElapsed();
    const expected = elapsed * TARGET_PER_HOUR;
    const diff = Math.round(total - expected);
    const minutesAhead = diff / TARGET_PER_HOUR * 60;
    const projectedTotal = (()=>{
      // estimate current rate based on last full-day rate or logs
      const rate = currentRatePerHour(t);
      const now = new Date();
      const end = new Date();
      end.setHours(START_HOUR+9,0,0,0); // end of day at 18:00
      const hoursLeft = Math.max(0, (end - now)/1000/3600);
      return Math.round(total + rate * hoursLeft);
    })();
    return { total, expected, diff, minutesAhead, projectedTotal, elapsed };
  }

  function currentRatePerHour(t){
    // prefer latest log rate if available and recent; else fall back to total/elapsed
    if(t.log && t.log.length>0){
      // use the most recent entry's ratePerHour if it has a timestamp within the day
      return t.log[0].ratePerHour || (t.total / Math.max(0.0001, hoursElapsed()));
    }
    const elapsed = hoursElapsed();
    return elapsed>0 ? t.total / elapsed : 0;
  }

  // render UI
  function render(){
    // update elapsed display
    const elapsedH = hoursElapsed();
    const h = Math.floor(elapsedH);
    const m = Math.floor((elapsedH - h)*60);
    elapsedDisplay.textContent = 'Elapsed: ' + h + 'h ' + m + 'min';
    // next refresh countdown will be handled separately
    board.innerHTML = '';
    // prepare array and sort by percent of daily target (or total desc)
    const arr = TEAMS.map(name => computeTeam(data[name]));
    // map names back
    for(let i=0;i<TEAMS.length;i++){ arr[i].name = TEAMS[i]; arr[i].raw = data[TEAMS[i]]; }
    arr.sort((a,b)=> b.total - a.total);

    arr.forEach((teamObj, idx)=>{
      const teamName = teamObj.name;
      const raw = teamObj.raw;
      const card = document.createElement('div');
      card.className = 'team-card';
      if(idx===0) card.classList.add('lead-1');
      if(idx===1) card.classList.add('lead-2');
      if(idx===
